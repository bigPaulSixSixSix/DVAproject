# 我的任务页面 - 前端方案说明

## 一、页面结构

### 1.1 布局设计

页面采用三列布局（使用 Element Plus 的 `el-row` 和 `el-col` 实现）：

```
┌─────────────────────────────────────────────────────────┐
│  顶部功能区：历史任务按钮 | 搜索框                        │
├──────────┬──────────────────────┬───────────────────────┤
│          │                      │                       │
│  分类列  │      任务列表列       │     任务明细列        │
│          │                      │                       │
│  - 项目  │  - 任务1              │  - 审批流程           │
│  - 部门  │  - 任务2              │  - 前后置任务关系     │
│  - 状态  │  - 任务3              │  - 任务明细           │
│          │  ...                 │  - 任务进度           │
│          │                      │  - 提交内容           │
│          │                      │  - 提交按钮（吸底）   │
└──────────┴──────────────────────┴───────────────────────┘
```

### 1.2 组件划分

1. **顶部功能区组件**：`TodoHeader.vue`
   - 历史任务按钮（样式，功能暂不实现）
   - 搜索框（样式，功能暂不实现）

2. **分类列组件**：`CategoryPanel.vue`
   - 项目分类
   - 部门分类
   - 状态分类
   - 每个分类显示计数

3. **任务列表组件**：`TaskList.vue`
   - 任务卡片列表
   - 支持点击选中
   - 显示任务状态图标和颜色

4. **任务明细组件**：`TaskDetail.vue`
   - 审批流程组件：`ApprovalFlow.vue`
   - 前后置任务组件：`TaskRelations.vue`
   - 任务明细组件：`TaskInfo.vue`
   - 任务进度组件：`TaskProgress.vue`
   - 提交内容组件：`SubmitContent.vue`
   - 提交按钮（吸底固定）

5. **其他任务详情弹窗**：`TaskDetailDialog.vue`
   - 用于查看前后置任务的详情

---

## 二、数据流设计

### 2.1 状态管理

使用 Vue 3 的 `ref` 和 `reactive` 进行状态管理：

```javascript
// 分类筛选状态
const filterState = reactive({
  projectId: null,    // 选中的项目ID
  deptId: null,        // 选中的部门ID
  taskStatus: null     // 选中的状态
})

// 分类统计数据
const categories = ref({
  project: { total: 0, items: [] },
  department: { total: 0, items: [] },
  status: { total: 0, items: [] }
})

// 任务列表数据
const taskList = ref([])
const loading = ref(false)

// 当前选中的任务
const selectedTask = ref(null)
const taskDetail = ref(null)
```

### 2.2 数据加载流程

1. **页面初始化**：
   ```
   加载分类统计 → 加载任务列表（无筛选） → 默认选中第一个任务 → 加载任务详情
   ```

2. **选择分类**：
   ```
   更新筛选状态 → 重新加载任务列表 → 清空选中任务 → 如果有任务则选中第一个
   ```

3. **点击任务**：
   ```
   更新选中任务 → 加载任务详情
   ```

4. **执行操作（提交/审批）**：
   ```
   调用操作接口 → 操作成功 → 刷新任务详情 → 刷新任务列表 → 刷新分类统计
   ```

---

## 三、关键功能实现

### 3.1 分类筛选

**实现方式**：
- 每个分类维度都有一个"全部"选项（显示总数）
- 点击分类项时，更新筛选状态并重新加载任务列表
- 支持多维度组合筛选（项目 + 部门 + 状态）

**筛选逻辑**：
```javascript
const handleCategoryClick = (type, value) => {
  if (type === 'project') {
    filterState.projectId = value === 'all' ? null : value
  } else if (type === 'department') {
    filterState.deptId = value === 'all' ? null : value
  } else if (type === 'status') {
    filterState.taskStatus = value === 'all' ? null : value
  }
  
  // 重新加载任务列表
  loadTaskList()
}
```

### 3.2 任务状态显示

**状态映射**：
- **进行中（1）**：蓝色向上箭头图标，显示剩余时间（考虑跨天）
- **已提交（2）**：橙色文档图标，显示剩余时间（考虑跨天）或"审批中"
- **驳回（4）**：红色叉号图标，显示驳回时间和原因（暂时不实现，先实现正常任务）

**剩余时间显示规则**：
- 如果剩余时间 < 24小时：显示"剩余X小时X分"（例如：剩余3小时5分）
- 如果剩余时间 >= 24小时：显示"剩余X天X小时"（例如：剩余2天3小时）
- 如果已逾期：显示"已逾期X天X小时"或"已逾期X小时X分"

**实现方式**：
- 根据任务状态和图标类型，动态渲染图标和颜色
- 使用 Element Plus 的图标组件或自定义 SVG 图标
- 实现剩余时间计算函数，考虑跨天情况

### 3.3 审批流程显示

**实现方式**：
- 使用水平流程图展示审批节点
- 节点状态：
  - 已审批：绿色，显示审批人、时间、意见
  - 审批中：蓝色高亮，表示当前节点
  - 待审批：灰色，表示等待审批

### 3.4 前后置任务关系

**实现方式**：
- 使用工作流图形式展示（类似任务配置页面的流程图）
- 左侧显示前置任务，中间显示当前任务，右侧显示后置任务
- 点击前后置任务，弹出详情弹窗

### 3.5 提交内容编辑

**实现方式**：
- 使用 `el-input`（type="textarea"）输入文本
- 使用图片上传组件上传图片（参考现有的文件上传组件）
- 支持多张图片上传和预览

### 3.6 提交按钮（吸底固定）

**实现方式**：
- 使用 `position: fixed` 固定在页面底部
- 根据任务状态和权限，显示不同的按钮：
  - 进行中 + 是负责人：显示"提交"按钮
  - 已提交 + 是审批人：显示"审批同意"和"审批驳回"按钮
  - 驳回 + 是负责人：显示"重新提交"按钮

**样式设计**：
```scss
.submit-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  padding: 16px 24px;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}
```

---

## 四、需要注意的问题

### 4.1 部门分类的特殊处理

**问题**：需求中要求按"第二级部门"分类，但任务可能关联的是第三级或更深层级的部门。

**解决方案**：
- ✅ **已确认**：后端会处理部门层级关系（通过部门的code字段，如02A01B01C01对应的第二级部门是02A01）
- 前端只需要直接使用后端返回的第二级部门分类数据，无需额外处理

### 4.2 任务状态筛选

**问题**：需求中只显示【进行中】、【已提交】、【驳回】三种状态，但后端可能返回其他状态。

**解决方案**：
- 后端接口应该只返回这三种状态的任务
- 前端也需要做二次过滤，确保不会显示其他状态的任务

### 4.3 审批权限判断

**问题**：如何判断当前用户是否有审批权限？

**解决方案**：
- ✅ **已确认**：后端会处理审批权限判断
- 后端数据库中有一个表专门存储当前审批人，会查询并返回给对应的用户
- 后端接口 `GET /todo/task/{task_id}/detail` 返回 `canApprove` 字段
- 前端根据 `canApprove` 字段显示/隐藏审批按钮
- 岗位（编制）与用户是一对一关系（可能有编制为空，但一个用户只可能在一个编制上）
- 如果用户尝试操作但没有权限，后端会返回错误，前端显示错误提示

### 4.4 图片上传

**问题**：提交内容和审批意见都需要上传图片，需要确认图片上传接口。

**解决方案**：
- ⏸️ **暂缓实现**：先只实现文字相关的功能，图片上传功能后续再实现
- 提交内容和审批意见接口中的 `submitImages` 和 `approvalImages` 字段暂时传空数组 `[]`

### 4.5 时间显示格式

**问题**：需要统一时间显示格式。

**解决方案**：
- ✅ **已确认**：后端使用本地时间（datetime.now()，不包含时区信息）
- 数据库字段类型：MySQL使用DATETIME，PostgreSQL使用TIMESTAMP WITHOUT TIME ZONE
- 时间格式：`YYYY-MM-DD HH:MM:SS`（例如：2025-01-20 10:00:00）
- API返回格式：`YYYY-MM-DD HH:MM:SS`
- 前端使用：
  - 使用系统现有的 `parseTime` 工具函数（`@/utils/ruoyi`）格式化时间
  - **剩余时间计算**：
    - 使用本地时间计算时间差（不涉及时区转换）
    - **需要考虑跨天的情况**：
      - 如果剩余时间小于24小时：显示"剩余X小时X分"
      - 如果剩余时间大于等于24小时：显示"剩余X天X小时"（例如：剩余2天3小时）
      - 如果已逾期：显示"已逾期X天X小时"或"已逾期X小时X分"
  - 显示格式：
    - 日期时间：`YYYY-MM-DD HH:mm:ss`
    - 日期：`YYYY-MM-DD`
    - 剩余时间：`剩余X小时X分` 或 `剩余X天X小时` 或 `已逾期X天X小时`
- 逾期时间也使用本地时间计算，不涉及跨时区问题

### 4.6 数据刷新策略

**问题**：执行操作后，需要刷新哪些数据？

**解决方案**：
- 提交任务后：刷新任务详情、任务列表、分类统计
- 审批操作后：刷新任务详情、任务列表、分类统计
- 选择分类后：只刷新任务列表

**实现方式**：
```javascript
const handleSubmit = async () => {
  await submitTask(taskId, submitText, submitImages)
  // 刷新数据
  await Promise.all([
    loadTaskDetail(taskId),
    loadTaskList(),
    loadCategories()
  ])
}
```

### 4.7 前后置任务详情弹窗

**问题**：点击前后置任务时，需要显示任务详情，但不需要显示操作按钮。

**解决方案**：
- 使用单独的接口 `GET /todo/task/{task_id}/detail/simple`
- 弹窗中只显示任务信息、提交内容、审批结果，不显示操作按钮
- 使用 Element Plus 的 `el-dialog` 组件实现

### 4.8 响应式设计

**问题**：三列布局在小屏幕上可能显示不佳。

**解决方案**：
- 使用 Element Plus 的响应式栅格系统
- 小屏幕时，可以改为上下布局或使用抽屉组件
- 使用媒体查询调整布局

---

## 五、开发计划

### 5.1 第一阶段：基础布局和数据结构

1. ✅ 创建页面基础结构（三列布局）
2. ✅ 创建 API 接口文件
3. ⏳ 实现分类列组件
4. ⏳ 实现任务列表组件
5. ⏳ 实现任务明细组件框架

### 5.2 第二阶段：数据加载和交互

1. ⏳ 实现分类统计数据加载
2. ⏳ 实现任务列表数据加载和筛选
3. ⏳ 实现任务详情数据加载
4. ⏳ 实现任务选中和详情显示

### 5.3 第三阶段：功能实现

1. ⏳ 实现审批流程显示
2. ⏳ 实现前后置任务关系显示
3. ⏳ 实现提交内容编辑
4. ⏳ 实现任务提交功能
5. ⏳ 实现审批功能

### 5.4 第四阶段：优化和测试

1. ⏳ 优化交互体验
2. ⏳ 添加加载状态和错误处理
3. ⏳ 测试各种场景
4. ⏳ 修复 bug

---

## 六、技术栈

- **框架**：Vue 3 + Composition API
- **UI 组件库**：Element Plus
- **HTTP 请求**：axios（已封装在 `@/utils/request`）
- **状态管理**：Vue 3 响应式 API（ref、reactive）
- **路由**：Vue Router（已配置）
- **工具库**：dayjs（时间处理，如果需要）

---

## 七、文件结构

```
src/views/workbench/todo/
├── index.vue                    # 主页面
├── components/
│   ├── TodoHeader.vue          # 顶部功能区
│   ├── CategoryPanel.vue       # 分类列
│   ├── TaskList.vue            # 任务列表
│   ├── TaskDetail.vue          # 任务明细
│   │   ├── ApprovalFlow.vue    # 审批流程
│   │   ├── TaskRelations.vue   # 前后置任务
│   │   ├── TaskInfo.vue        # 任务信息
│   │   ├── TaskProgress.vue   # 任务进度
│   │   └── SubmitContent.vue   # 提交内容
│   └── TaskDetailDialog.vue    # 其他任务详情弹窗
└── api/
    └── todo.js                  # API 接口定义
```

---

## 八、与后端协作事项

### 8.1 需要确认的问题

1. **部门层级结构**：
   - 确认第二级部门的具体定义
   - 确认如何从任务关联的部门找到第二级部门

2. **文件上传接口**：
   - 确认文件上传接口地址
   - 确认上传参数格式
   - 确认返回的图片URL格式

3. **时间格式**：
   - 确认后端返回的时间格式
   - 确认时区处理方式

4. **权限判断**：
   - 确认如何判断用户是否有审批权限
   - 确认岗位和用户的关系

### 8.2 接口开发优先级

根据前端开发计划，建议后端按以下优先级开发接口：

1. **高优先级**（第一阶段需要）：
   - `GET /todo/my/tasks/categories` - 分类统计
   - `GET /todo/my/tasks/list` - 任务列表
   - `GET /todo/task/{task_id}/detail` - 任务详情

2. **中优先级**（第二阶段需要）：
   - `POST /todo/submit/{task_id}` - 提交任务
   - `POST /todo/resubmit/{task_id}` - 重新提交
   - `POST /todo/approve/{apply_id}` - 审批同意
   - `POST /todo/reject/{apply_id}` - 审批驳回

3. **低优先级**（第三阶段需要）：
   - `GET /todo/task/{task_id}/detail/simple` - 其他任务详情

---

## 九、总结

本文档详细说明了"我的任务"页面的前端实现方案，包括：

1. ✅ 页面结构和组件划分
2. ✅ 数据流设计
3. ✅ 关键功能实现方式
4. ✅ 需要注意的问题和解决方案
5. ✅ 开发计划
6. ✅ 与后端协作事项

**下一步行动**：
1. 与后端确认接口文档中的问题
2. 开始第一阶段开发（基础布局和数据结构）
3. 等待后端接口开发完成后，进行联调测试

如有问题，请及时沟通。
