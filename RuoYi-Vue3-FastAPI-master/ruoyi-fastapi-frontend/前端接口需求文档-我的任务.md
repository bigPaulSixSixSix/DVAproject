# 我的任务页面 - 前端接口需求文档

## 一、概述

本文档定义了"我的任务"页面所需的所有后端接口。该页面采用三列布局：分类、任务列表、任务明细。

**页面路径**：`/workbench/todo`

**数据范围**：仅显示负责人是当前用户 + 状态为【进行中】、【已提交】、【驳回】的任务（排除【未开始】和【完成】状态）。

**重要说明**：
1. 所有时间字段使用本地时间（不包含时区信息），格式：`YYYY-MM-DD HH:MM:SS`
2. 字段命名规范：JSON响应中使用camelCase（如`approvalNodes`），数据库字段使用下划线（如`approval_nodes`）
3. 驳回相关功能暂时不实现，先实现正常的任务获取功能
4. 图片上传功能暂时不实现，`submitImages`和`approvalImages`字段传空数组`[]`

---

## 二、接口列表

### 2.1 任务分类统计接口

#### 2.1.1 获取我的任务分类统计

**接口地址**：`GET /todo/my/tasks/categories`

**接口描述**：获取当前用户的任务分类统计信息，用于左侧分类列展示。返回三个维度的分类：项目、部门、状态。

**请求参数**：无（自动获取当前登录用户信息）

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "project": {
      "total": 10,
      "items": [
        {
          "projectId": 1,
          "projectName": "高邮项目",
          "count": 3
        },
        {
          "projectId": 2,
          "projectName": "华士项目",
          "count": 2
        }
      ]
    },
    "department": {
      "total": 10,
      "items": [
        {
          "deptId": 101,
          "deptName": "开发施工",
          "count": 5
        },
        {
          "deptId": 102,
          "deptName": "设计装饰",
          "count": 3
        },
        {
          "deptId": 103,
          "deptName": "财务合约",
          "count": 2
        }
      ]
    },
    "status": {
      "total": 10,
      "items": [
        {
          "status": 1,
          "statusName": "进行中",
          "count": 4
        },
        {
          "status": 2,
          "statusName": "已提交",
          "count": 3
        },
        {
          "status": 4,
          "statusName": "驳回",
          "count": 3
        }
      ]
    }
  },
  "success": true,
  "time": "2025-01-20 10:00:00"
}
```

**字段说明**：
- `project.items`: 项目分类列表（按项目ID分组）
- `department.items`: 部门分类列表（仅显示第二级部门：开发施工、设计装饰、财务合约）
- `status.items`: 状态分类列表（仅包含：1-进行中、2-已提交、4-驳回）
- 每个分类的 `total` 表示该维度下的任务总数
- 每个分类项的 `count` 表示该分类下的任务数量

**业务规则**：
1. 只统计负责人是当前用户的任务
2. 只统计状态为【进行中】、【已提交】、【驳回】的任务
3. 部门分类只显示第二级部门（开发施工、设计装饰、财务合约）
4. 状态分类只显示：进行中、已提交、驳回（不包含未开始、完成、返还、跟踪、消息）

---

### 2.2 任务列表查询接口

#### 2.2.1 获取我的任务列表

**接口地址**：`GET /todo/my/tasks/list`

**接口描述**：获取当前用户的任务列表，支持按项目、部门、状态筛选。

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectId | int | 否 | 项目ID（筛选条件，不传表示全部项目） |
| deptId | int | 否 | 部门ID（筛选条件，不传表示全部部门） |
| taskStatus | int | 否 | 任务状态（筛选条件，1-进行中，2-已提交，4-驳回，不传表示全部状态） |
| pageNum | int | 否 | 页码（默认1） |
| pageSize | int | 否 | 每页数量（默认10） |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "total": 10,
    "rows": [
      {
        "taskId": 101,
        "taskName": "总评方案确认",
        "projectId": 1,
        "projectName": "高邮项目",
        "deptId": 101,
        "deptName": "开发施工",
        "taskStatus": 2,
        "taskStatusName": "已提交",
        "assignee": "user001",
        "assigneeName": "凤苒溪",
        "deadline": "2025-01-20 18:00:00",
        "stageId": 1,
        "stageName": "招拍挂手续",
        "iconType": "arrow-up",
        "iconColor": "#409EFF"
      }
    ]
  },
  "success": true,
  "time": "2025-01-20 10:00:00"
}
```

**字段说明**：
- `taskId`: 任务ID（关联proj_task.task_id）
- `taskName`: 任务名称
- `projectId` / `projectName`: 项目信息
- `deptId` / `deptName`: 部门信息（第二级部门）
- `taskStatus`: 任务状态（1-进行中，2-已提交，4-驳回）
- `taskStatusName`: 任务状态名称（用于显示）
- `assignee` / `assigneeName`: 负责人信息
- `deadline`: 截止时间（仅进行中、已提交状态有值，格式：YYYY-MM-DD HH:MM:SS）
- `rejectTime`: 驳回时间（仅驳回状态有值，格式：YYYY-MM-DD HH:MM:SS）
- `stageId` / `stageName`: 所属阶段信息
- `iconType`: 图标类型（用于前端显示，arrow-up-向上箭头，document-文档，close-叉号）
- `iconColor`: 图标颜色（用于前端显示）

**业务规则**：
1. 只返回负责人是当前用户的任务
2. 只返回状态为【进行中】、【已提交】、【驳回】的任务
3. 支持按项目、部门、状态筛选（可组合筛选）
4. 支持分页
5. 默认按任务创建时间正序排列（早创建的任务排在前面，更需要注意）
6. **前端计算剩余时间**：
   - 前端需要根据 `deadline` 字段和当前时间计算剩余时间
   - 因为剩余时间是实时更新的，不可能后端一直更新
   - **计算规则**：
     - 如果剩余时间小于24小时：显示"剩余X小时X分"（例如：剩余3小时5分）
     - 如果剩余时间大于等于24小时：显示"剩余X天X小时"（例如：剩余2天3小时）
     - 如果已逾期：显示"已逾期X天X小时"或"已逾期X小时X分"（根据逾期时长决定显示格式）

---

### 2.3 任务详情接口

#### 2.3.1 获取任务详情

**接口地址**：`GET /todo/task/{task_id}/detail`

**接口描述**：获取任务的完整详情信息，包括审批流程、前后置任务、任务明细、任务进度等。

**路径参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| task_id | int | 是 | 任务ID（关联proj_task.task_id） |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "taskInfo": {
      "taskId": 101,
      "taskName": "规划方案初稿确认",
      "taskDescription": "任务描述...",
      "projectId": 1,
      "projectName": "高邮项目",
      "stageId": 1,
      "stageName": "招拍挂手续",
      "deptId": 101,
      "deptName": "开发施工",
      "assignee": "user001",
      "assigneeName": "凤苒溪",
      "taskStatus": 2,
      "taskStatusName": "已提交"
    },
    "approvalFlow": {
      "applyId": "1234567890123456789",
      "approvalNodes": [
        {
          "nodeIndex": 1,
          "postId": 1,
          "postName": "设计负责人",
          "status": "approved",
          "approverId": "user002",
          "approverName": "王二狗",
          "approvalTime": "2025-01-20 10:00:00",
          "approvalComment": "同意"
        },
        {
          "nodeIndex": 2,
          "postId": 2,
          "postName": "项目经理",
          "status": "approving",
          "approverId": "user003",
          "approverName": "王三狗",
          "approvalTime": null,
          "approvalComment": null
        },
        {
          "nodeIndex": 3,
          "postId": 3,
          "postName": "部门经理",
          "status": "pending",
          "approverId": null,
          "approverName": null,
          "approvalTime": null,
          "approvalComment": null
        }
      ],
      "currentApprovalNode": 2
    },
    "taskRelations": {
      "predecessorTasks": [],
      "successorTasks": []
    },
    "taskProgress": {
      "totalDuration": 2,
      "startTime": "2024-03-08",
      "endTime": "2024-03-09",
      "actualStartTime": "2024-03-08 09:00:00",
      "actualEndTime": null,
      "currentStatus": "进行中",
      "isOverdue": true,
      "overdueDays": 1
    },
    "submitContent": {
      "submitText": "任务已完成",
      "submitImages": [],
      "submitTime": "2025-01-20 10:00:00"
    },
    "rejectInfo": {
      "rejectTime": "2025-01-19 15:30:00",
      "rejectReason": "需要补充材料"
    },
    "canSubmit": false,
    "canApprove": true,
    "canResubmit": false
  },
  "success": true,
  "time": "2025-01-20 10:00:00"
}
```

**字段说明**：

**taskInfo（任务基本信息）**：
- `taskId`: 任务ID
- `taskName`: 任务名称
- `taskDescription`: 任务描述
- `projectId` / `projectName`: 项目信息
- `stageId` / `stageName`: 所属阶段信息
- `deptId` / `deptName`: 部门信息
- `assignee` / `assigneeName`: 负责人信息
- `taskStatus`: 任务状态（1-进行中，2-已提交，4-驳回）
- `taskStatusName`: 任务状态名称

**approvalFlow（审批流程）**：
- `applyId`: 申请单ID
- `approvalNodes`: 审批节点列表
  - `nodeIndex`: 节点序号（从1开始）
  - `postId`: 岗位ID
  - `postName`: 岗位名称
  - `status`: 节点状态（approved-已审批，approving-审批中，pending-待审批）
  - `approverId` / `approverName`: 审批人信息
    - **已审批节点（approved）**：返回实际审批人的ID和姓名
    - **审批中节点（approving）**：**必须返回当前审批人的ID和姓名**
      - **获取逻辑**：从 `apply_rules.current_approval_node` 获取当前需要审批的岗位ID，然后查询该岗位对应的员工，返回员工ID和姓名
      - 即使还未审批，也要返回当前应该审批的人信息
    - **待审批节点（pending）**：为 null
  - `approvalTime`: 审批时间（已审批节点有值，其他为null）
  - `approvalComment`: 审批意见（已审批节点有值，其他为null）
- `currentApprovalNode`: 当前审批节点序号（null表示审批流程已结束）

**taskRelations（任务关系）**：
- `predecessorTasks`: 前置任务列表（仅显示一级前置任务）
- `successorTasks`: 后置任务列表（仅显示一级后置任务）

**taskProgress（任务进度）**：
- `totalDuration`: 总工期（天）
- `startTime`: 计划开始时间
- `endTime`: 计划结束时间
- `actualStartTime`: 实际开始时间
- `actualEndTime`: 实际完成时间（null表示未完成）
- `currentStatus`: 当前状态描述
- `isOverdue`: 是否逾期
- `overdueDays`: 逾期天数

**submitContent（提交内容）**：
- `submitText`: 提交文本
- `submitImages`: 提交图片URL列表（当前版本暂不使用，传空数组）
- `submitTime`: 提交时间

**rejectInfo（驳回信息，仅驳回状态的任务有值）**：
- `rejectTime`: 驳回时间
- `rejectReason`: 驳回原因（驳回时审批人填写的审批意见）
- **注意**：驳回相关功能暂时不实现，先实现正常的任务获取功能，但接口中保留该字段结构

**权限标识**：
- `canSubmit`: 是否可以提交（任务状态为【进行中】且当前用户是负责人）
- `canApprove`: 是否可以审批（任务状态为【已提交】且当前用户是当前审批节点的审批人）
- `canResubmit`: 是否可以重新提交（任务状态为【驳回】且当前用户是负责人）

**业务规则**：
1. 如果任务未提交，`submitContent` 为 null
2. 如果任务没有审批流程，`approvalFlow` 为 null
3. 如果任务未被驳回，`rejectInfo` 为 null
4. 前后置任务只显示一级关系
5. 审批节点状态说明：
   - `approved`: 该节点已审批通过，返回审批人信息和审批时间、意见
   - `approving`: 该节点正在审批中（当前审批节点），**必须返回当前审批人的ID和姓名**
   - `pending`: 该节点待审批，审批人信息为 null

---

### 2.4 其他任务详情接口（弹窗查看）

#### 2.4.1 获取其他任务详情（用于弹窗）

**接口地址**：`GET /todo/task/{task_id}/detail/simple`

**接口描述**：获取其他任务的详情信息（用于在弹窗中查看前后置任务的详情）。与详情接口类似，但只返回查看所需的信息，不包含操作按钮相关的权限标识。

**路径参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| task_id | int | 是 | 任务ID |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "taskInfo": {
      "taskId": 100,
      "taskName": "前置任务1",
      "taskDescription": "任务描述...",
      "projectId": 1,
      "projectName": "高邮项目",
      "stageId": 1,
      "stageName": "招拍挂手续",
      "assignee": "user004",
      "assigneeName": "袁子园",
      "taskStatus": 3,
      "taskStatusName": "完成"
    },
    "approvalFlow": {
      "applyId": "1234567890123456788",
      "approvalNodes": [
        {
          "nodeIndex": 1,
          "postId": 1,
          "postName": "设计负责人",
          "status": "approved",
          "approverId": "user002",
          "approverName": "王二狗",
          "approvalTime": "2025-01-19 10:00:00",
          "approvalComment": "同意"
        }
      ],
      "currentApprovalNode": null
    },
    "submitContent": {
      "submitText": "任务已完成",
      "submitImages": [],
      "submitTime": "2025-01-19 09:00:00"
    },
    "approvalResults": [
      {
        "nodeIndex": 1,
        "postName": "设计负责人",
        "approverName": "王二狗",
        "approvalTime": "2025-01-19 10:00:00",
        "approvalComment": "同意",
        "approvalImages": []
      }
    ]
  },
  "success": true,
  "time": "2025-01-20 10:00:00"
}
```

**字段说明**：
- 与详情接口类似，但增加了 `approvalResults` 字段，用于显示所有审批节点的审批结果
- `approvalResults`: 审批结果列表（包含所有已审批节点的审批意见和图片）
- 不包含 `canSubmit`、`canApprove`、`canResubmit` 等权限标识字段

---

### 2.5 任务操作接口

#### 2.5.1 提交任务

**接口地址**：`POST /todo/submit/{task_id}`

**接口描述**：任务负责人提交任务（已在API文档中定义，此处仅作引用）

**路径参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| task_id | int | 是 | 任务ID |

**请求体**：
```json
{
  "submitText": "任务已完成，具体情况如下：...",
  "submitImages": [
    "http://example.com/image1.jpg",
    "http://example.com/image2.jpg"
  ]
}
```

---

#### 2.5.2 重新提交任务

**接口地址**：`POST /todo/resubmit/{task_id}`

**接口描述**：被驳回的任务重新提交（已在API文档中定义，此处仅作引用）

---

#### 2.5.3 审批同意

**接口地址**：`POST /todo/approve/{apply_id}`

**接口描述**：审批人同意申请单（已在API文档中定义，此处仅作引用）

---

#### 2.5.4 审批驳回

**接口地址**：`POST /todo/reject/{apply_id}`

**接口描述**：审批人驳回申请单（已在API文档中定义，此处仅作引用）

---

## 三、接口依赖关系

### 3.1 页面加载流程

1. **初始化**：
   - 首先调用 `GET /todo/my/tasks/categories` 获取分类统计（返回该账户各种任务的计数，用于显示分类）
   - 然后调用 `GET /todo/my/tasks/list` 获取任务列表（默认不筛选，按创建时间正序排列）

2. **选择分类**：
   - 根据选择的分类，调用 `GET /todo/my/tasks/list` 并传入筛选参数（项目ID、部门ID、状态）

3. **点击任务**：
   - 调用 `GET /todo/task/{task_id}/detail` 获取任务详情

4. **点击前后置任务**：
   - 调用 `GET /todo/task/{task_id}/detail/simple` 获取其他任务详情（弹窗显示）

5. **提交/审批操作**：
   - 调用相应的操作接口（提交、重新提交、审批同意、审批驳回）
   - 操作成功后，刷新任务详情和任务列表

---

## 四、特殊说明

### 4.1 部门分类规则

- 只显示第二级部门：开发施工、设计装饰、财务合约
- **后端处理逻辑**：通过部门的code字段（如02A01B01C01对应的第二级部门是02A01）来判断和归类
- 如果任务关联的部门不是第二级部门，后端需要向上查找其所属的第二级部门
- 前端只需要直接使用后端返回的第二级部门分类数据，无需额外处理

### 4.2 状态分类规则

- 只显示：进行中（1）、已提交（2）、驳回（4）
- 不显示：未开始（0）、完成（3）、返还、跟踪、消息等其他状态

### 4.3 任务筛选规则

- 只显示负责人是当前用户的任务
- 只显示状态为【进行中】、【已提交】、【驳回】的任务
- 支持按项目、部门、状态组合筛选

---

## 五、接口优先级

### 5.1 第一阶段（核心功能）

1. ✅ `GET /todo/my/tasks/categories` - 分类统计（必须）
2. ✅ `GET /todo/my/tasks/list` - 任务列表（必须）
3. ✅ `GET /todo/task/{task_id}/detail` - 任务详情（必须）
4. ✅ `POST /todo/submit/{task_id}` - 提交任务（必须）
5. ✅ `POST /todo/resubmit/{task_id}` - 重新提交（必须）
6. ✅ `POST /todo/approve/{apply_id}` - 审批同意（必须）
7. ✅ `POST /todo/reject/{apply_id}` - 审批驳回（必须）

### 5.2 第二阶段（增强功能）

8. ⚠️ `GET /todo/task/{task_id}/detail/simple` - 其他任务详情（用于弹窗，优先级较高）

---

## 六、版本信息

- **文档版本**：v1.0.0
- **创建日期**：2025-01-20
- **最后更新**：2025-01-20
- **适用页面**：我的任务（/workbench/todo）
- **字段命名更新**：已统一将 `approval_levels` 改为 `approval_nodes`（后端数据库字段）和 `approvalNodes`（JSON响应字段）

---

## 七、联系方式

如有问题，请联系前端开发团队。
