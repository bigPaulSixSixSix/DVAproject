# 最终确认要点总结

基于您的所有回复，以下是最终确认的所有要点：

## 一、核心原则

1. **只允许编辑未生成的任务/阶段**，不允许编辑已生成的任务/阶段（但允许编辑已生成任务/阶段的后置关系）
2. **渐进式生成**：只生成第一层任务/阶段，后续任务/阶段在前置任务/阶段完成后动态生成
3. **不存在跨阶段任务关联**：任务的前置任务必须在同一个阶段内

---

## 二、is_editable 计算逻辑

**规则**：只要是没被生成的任务/阶段，就可以被编辑

**判断方式**：
- 查询 `todo_task` 表，如果任务ID存在，则任务已生成，不可编辑
- 查询 `todo_stage` 表，如果阶段ID存在，则阶段已生成，不可编辑
- 对于未生成任务的项目，所有任务/阶段都可以随意编辑

**实现方式**：动态计算，不存储字段

---

## 三、任务/阶段编辑的限制

### 3.1 可编辑任务/阶段（未生成）
- ✅ 可以编辑全部信息（名称、描述、时间、负责人、审批节点等）
- ✅ 可以编辑前后置关系
- ✅ 可以移动阶段
- ✅ 可以删除（软删除，enable='0'）

### 3.2 不可编辑任务/阶段（已生成）
- ❌ 不可以编辑基本信息（名称、描述、时间等）
- ❌ 不可以编辑前置关系（predecessor_tasks/predecessor_stages）
- ✅ 可以编辑后置关系（successor_tasks/successor_stages），但只限于添加/删除未生成的任务/阶段
- ❌ 不可以删除

### 3.3 后置关系编辑的具体规则

**允许的操作**：
1. A已生成，B未生成，当前无联系 → 可以设置关系 A->B ✅
2. A已生成，B未生成，当前存在联系 A->B → 可以删除关系 A->B ✅
3. A已生成，B可编辑 → 可以设置关系 B->A（B是A的前置）✅

**不允许的操作**：
1. A已生成，B未生成 → 不可以设置关系 B->A（B指向A）❌
2. A已生成，B已生成，当前存在联系 A->B → 不可以删除关系 A->B ❌
3. A已生成，B已生成 → 不可以设置新的关系 ❌

---

## 四、任务生成逻辑

### 4.1 第一次生成任务

**生成条件**：
- 任务：没有前置任务（predecessor_tasks 为空）
- 阶段：没有前置阶段（predecessor_stages 为空）

**生成顺序**：
1. 先生成没有前置阶段的阶段（状态为进行中）
2. 然后生成这些阶段中没有前置任务的任务（状态为进行中）

**状态初始化**：
- 所有能生成的任务，状态都是 1（进行中），记录 `actual_start_time`
- 所有能生成的阶段，状态都是 1（进行中），记录 `actual_start_time`

### 4.2 动态生成任务

**生成时机**：
- 任务完成后，检查后置任务是否满足生成条件
- 阶段完成后，检查后置阶段是否满足生成条件

**生成条件**：
- 任务：所有前置任务都已完成（状态为3）
- 阶段：所有前置阶段都已完成（状态为2）

**生成逻辑**：
1. 获取当前任务/阶段的后置任务/阶段列表（从 proj_task/proj_stage 表）
2. 对于每个后置任务/阶段：
   - 获取前置任务/阶段列表（从 proj_task/proj_stage 表）
   - 检查所有前置任务/阶段是否都完成（在 todo_task/todo_stage 表中查询）
   - 如果都完成，生成该后置任务/阶段（插入新记录到 todo_task/todo_stage 表）
   - 生成的任务/阶段状态为 1（进行中），记录 `actual_start_time`

**阶段生成后的任务生成**：
- 阶段生成后，检查阶段中的任务是否满足生成条件
- 只生成那些"没有任何前置任务的任务"（阶段内的头任务）
- 后续其他任务的生成遵循动态生成逻辑（前置任务完成后生成）

### 4.3 保存更新后的任务生成

**检查范围**：
- 检查所有新增的任务（task_id 不在 existing_tasks_map 中）
- 检查所有编辑的任务（task_id 在 existing_tasks_map 中，但内容有变化）
- 检查由于前后置关系变更而新满足生成条件的任务

**生成条件**：
- 任务：没有前置任务，或所有前置任务都已完成
- 阶段：没有前置阶段，或所有前置阶段都已完成

**立即生成**：
- 如果满足生成条件，立即生成这些任务/阶段（插入新记录到 todo_task/todo_stage 表）
- 生成的任务/阶段状态为 1（进行中），记录 `actual_start_time`

---

## 五、任务完成后的处理

**处理流程**：
1. 更新任务状态为完成（状态为3），记录 `actual_complete_time`
2. 检查后置任务（生成满足条件的后置任务）
3. 检查阶段完成（如果阶段中所有任务都完成，更新阶段状态为已完成）
4. 如果阶段完成，检查后置阶段（生成满足条件的后置阶段）
5. 如果生成了新阶段，检查阶段中的任务是否满足生成条件（生成阶段内的头任务）

---

## 六、阶段状态更新

**阶段生成后的状态**：
- 阶段生成后，状态为 1（进行中），记录 `actual_start_time`
- 阶段生成后，会检查阶段中的任务，生成那些没有前置任务的任务
- 阶段生成后只可能是进行中或已完成，不可能出现所有任务都不满足生成条件的情况（因为每个阶段内必然有头任务）

**阶段状态更新规则**：
- 阶段中有任何一个任务没完成 → 阶段状态为 1（进行中）
- 阶段中所有任务都完成 → 阶段状态为 2（已完成），记录 `actual_complete_time`

---

## 七、任务删除的处理

**已生成的任务**：
- ❌ 不可以删除（软删除也不允许）
- 后端需要检查并限制

**未生成的任务**：
- ✅ 可以删除（软删除，enable='0'）
- 删除的任务自然不会被生成

---

## 八、前后置任务关系查询

**查询逻辑**：
- 需要同时查询 `todo_task` 和 `proj_task` 表
- 先从 `todo_task` 表查询（已生成的任务）
- 如果查询不到，从 `proj_task` 表查询（未生成的任务）
- 合并结果，返回完整的前后置任务关系

**未生成任务的字段**：
- 如果任务只在 `proj_task` 中，状态为"未生成"（或特殊状态值）
- 其他字段为 null 或适配的空类型
- 保持接口字段一致，方便前端加载

---

## 九、需要确认的遗留问题

### 问题1：阶段的可编辑性判断逻辑

**回复4说**："规则需修改。同任务。"

**需要确认**：
- 阶段的可编辑性判断逻辑是否和任务一样（只要是没被生成的阶段，就可以被编辑）？
- 如果阶段中有已生成的任务，阶段是否可编辑？

**我的理解**：
- 阶段的可编辑性应该和任务一样：只要是没被生成的阶段，就可以被编辑
- 阶段中有已生成的任务，不影响阶段的可编辑性（因为阶段和任务是独立的）

// 只要是没被生成的阶段，就可以被编辑。已生成的阶段就不可编辑。
根据之前的逻辑可知，永远都是先生成阶段、再生成任务，因此不可能存在一个阶段，它内部有任务被生成了，但这个阶段还没被生成。

### 问题2：阶段编辑的限制

**需要确认**：
- 已生成的阶段，是否也只允许编辑后置关系（successor_stages）？
- 已生成的阶段，是否可以添加新的任务？

**我的理解**：
- 已生成的阶段，只允许编辑后置关系（successor_stages），不允许编辑前置关系（predecessor_stages）
- 已生成的阶段，可以添加新的任务（但新任务需要遵循编辑限制）
// 对的。

### 问题3：任务生成时的阶段检查

**需要确认**：
- 任务生成时，是否需要检查所属阶段是否已生成？
- 如果阶段未生成，任务是否可以生成？

**我的理解**：
- 任务生成时，需要检查所属阶段是否已生成
- 如果阶段未生成，任务不应该生成（因为阶段生成后，会检查阶段中的任务）
// 其实不存在这种情况。首先，任务生成只会有两种情况：
1.阶段生成后，自动触发生成所有阶段内的头部任务。此时阶段肯定是生成了的，故不需要检查。
2.前置任务完成后，自动触发后置任务的生成。此时阶段肯定在进行中，也就是被生成了的，故不需要检查。
---

## 十、实施计划

### 阶段1：数据库和基础逻辑
1. ✅ 添加 `is_editable` 计算逻辑（动态计算，不存储字段）
2. ✅ 修改任务生成逻辑（只生成第一层任务）
3. ✅ 修改任务完成后的处理（生成后置任务）

### 阶段2：任务编辑功能
1. ✅ 添加编辑限制检查
2. ✅ 添加任务更新逻辑（更新已生成任务的后置关系）
3. ✅ 修改保存接口（保存后检查并生成任务）

### 阶段3：前后置任务关系查询
1. ✅ 修改任务详情接口（同时查询 todo 和 proj 表）
2. ✅ 修改任务列表接口（处理未生成的任务）

### 阶段4：测试和优化
1. ✅ 添加详细日志
2. ✅ 确保代码逻辑正确完善

---

## 总结

所有关键问题都已确认，可以开始实施。但还有3个遗留问题需要确认（关于阶段的可编辑性和编辑限制）。
