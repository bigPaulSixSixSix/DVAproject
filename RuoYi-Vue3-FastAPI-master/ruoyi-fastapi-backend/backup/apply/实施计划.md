# 任务编辑和渐进式生成功能实施计划

## 一、实施概述

### 核心功能
1. **任务编辑**：只允许编辑未生成的任务/阶段，已生成的任务/阶段只允许编辑后置关系
2. **渐进式生成**：只生成第一层任务/阶段，后续任务/阶段在前置任务/阶段完成后动态生成

### 实施原则
- 动态计算 `is_editable`，不存储字段
- 不存在跨阶段任务关联
- 阶段生成后，只生成阶段内的头任务（没有前置任务的任务）

---

## 二、实施步骤

### 阶段1：基础逻辑和工具方法

#### 1.1 添加 is_editable 计算逻辑
**文件**：`module_task/configuration/service/task_service.py` 或新建工具类

**功能**：
- `is_task_editable(db, task_id)`：判断任务是否可编辑
  - 查询 `todo_task` 表，如果任务ID存在，则不可编辑
  - 否则可编辑
- `is_stage_editable(db, stage_id)`：判断阶段是否可编辑
  - 查询 `todo_stage` 表，如果阶段ID存在，则不可编辑
  - 否则可编辑

#### 1.2 添加任务/阶段生成检查逻辑
**文件**：`module_task/todo/service/todo_service.py`

**功能**：
- `check_task_generation_condition(db, task_id)`：检查任务是否满足生成条件
  - 获取任务的前置任务列表（从 proj_task 表）
  - 如果前置任务为空，返回 True
  - 否则检查所有前置任务是否都完成（在 todo_task 表中查询，状态为3）
- `check_stage_generation_condition(db, stage_id)`：检查阶段是否满足生成条件
  - 获取阶段的前置阶段列表（从 proj_stage 表）
  - 如果前置阶段为空，返回 True
  - 否则检查所有前置阶段是否都完成（在 todo_stage 表中查询，状态为2）

#### 1.3 统一任务生成方法
**文件**：`module_task/todo/service/todo_service.py`

**功能**：
- `generate_task_if_ready(db, task_id, project_id)`：如果任务满足生成条件，生成任务
  - 检查任务是否已在 todo_task 表中（如果已生成，跳过）
  - 检查任务是否满足生成条件
  - 如果满足，从 proj_task 表读取任务配置，插入到 todo_task 表
  - 任务状态为 1（进行中），记录 `actual_start_time`
- `generate_stage_if_ready(db, stage_id, project_id)`：如果阶段满足生成条件，生成阶段
  - 检查阶段是否已在 todo_stage 表中（如果已生成，跳过）
  - 检查阶段是否满足生成条件
  - 如果满足，从 proj_stage 表读取阶段配置，插入到 todo_stage 表
  - 阶段状态为 1（进行中），记录 `actual_start_time`
  - 生成阶段后，检查阶段中的任务是否满足生成条件（生成阶段内的头任务）

---

### 阶段2：修改任务生成逻辑

#### 2.1 修改第一次生成任务逻辑
**文件**：`module_task/todo/service/todo_service.py` - `generate_tasks_from_project`

**修改内容**：
- 不再生成所有任务，只生成满足条件的任务：
  - 没有前置任务（predecessor_tasks 为空）
  - 所属阶段没有前置阶段（predecessor_stages 为空），或者阶段不存在
- 不再生成所有阶段，只生成满足条件的阶段：
  - 没有前置阶段（predecessor_stages 为空）
- 生成的任务/阶段状态为 1（进行中），记录 `actual_start_time`

#### 2.2 修改任务完成后的处理逻辑
**文件**：`module_task/todo/service/todo_service.py` - `_check_and_activate_successor_tasks`

**修改内容**：
- 不再更新后置任务状态，而是生成后置任务
- 获取当前任务的后置任务列表（从 proj_task 表）
- 对于每个后置任务，检查是否满足生成条件
- 如果满足，调用 `generate_task_if_ready` 生成任务
- 检查阶段完成，如果阶段完成，检查后置阶段（调用 `generate_stage_if_ready`）

#### 2.3 修改阶段完成后的处理逻辑
**文件**：`module_task/todo/service/todo_service.py` - `_check_and_activate_stages`

**修改内容**：
- 阶段完成后，检查后置阶段是否满足生成条件
- 如果满足，调用 `generate_stage_if_ready` 生成阶段
- 阶段生成后，会自动检查阶段中的任务是否满足生成条件

---

### 阶段3：添加任务编辑限制检查

#### 3.1 添加编辑限制检查
**文件**：`module_task/configuration/service/persistence/task_persistence.py` - `persist_task_config`

**功能**：
- 在保存任务配置前，检查是否尝试编辑不允许编辑的任务/阶段
- 对于已生成的任务：
  - 不允许修改基本信息（名称、描述、时间、负责人、审批节点等）
  - 不允许修改前置关系（predecessor_tasks）
  - 允许修改后置关系（successor_tasks），但只限于添加/删除未生成的任务
- 对于已生成的阶段：
  - 不允许修改基本信息（名称、时间等）
  - 不允许修改前置关系（predecessor_stages）
  - 允许修改后置关系（successor_stages），但只限于添加/删除未生成的阶段
  - 允许添加新的任务（但新任务需要遵循编辑限制）

#### 3.2 添加任务更新逻辑
**文件**：`module_task/todo/service/todo_service.py` 或新建方法

**功能**：
- `update_generated_task_successors(db, task_id, new_successor_tasks)`：更新已生成任务的后置关系
  - 验证任务是否已生成
  - 验证新的后置任务列表是否符合规则（只包含未生成的任务）
  - 更新 proj_task 表的 successor_tasks 字段
  - 更新 todo_task 表的 successor_tasks 字段（如果任务已生成）

#### 3.3 修改保存接口
**文件**：`module_task/configuration/service/task_service.py` - `process_task_config_services`

**修改内容**：
- 在 `persist_task_config` 完成后，检查项目是否已生成任务
- 如果已生成，检查新增/编辑的任务是否满足生成条件
- 如果满足，立即生成这些任务（调用 `generate_task_if_ready`）
- 检查由于前后置关系变更而新满足生成条件的任务
- 如果满足，立即生成这些任务

---

### 阶段4：修改前后置任务关系查询

#### 4.1 修改任务详情接口
**文件**：`module_task/todo/service/todo_query_service.py` - `get_task_detail`

**修改内容**：
- 前后置任务查询需要同时查询 `todo_task` 和 `proj_task` 表
- 先从 `todo_task` 表查询（已生成的任务）
- 如果查询不到，从 `proj_task` 表查询（未生成的任务）
- 未生成任务的字段：
  - 状态为"未生成"（或特殊状态值，如 -1）
  - 其他字段为 null 或适配的空类型
  - 保持接口字段一致，方便前端加载

#### 4.2 修改任务列表接口
**文件**：`module_task/todo/service/todo_query_service.py` - `get_my_tasks_list`

**修改内容**：
- 如果需要显示未生成的任务，需要同时查询 `todo_task` 和 `proj_task` 表
- 合并结果，返回完整的任务列表

---

### 阶段5：添加 is_editable 字段到接口

#### 5.1 修改任务配置查询接口
**文件**：`module_task/configuration/service/task_service.py` - `get_task_config_by_project_id_services`

**修改内容**：
- 在返回的任务/阶段数据中，添加 `isEditable` 字段
- 动态计算每个任务/阶段的可编辑性
- 对于未生成任务的项目，所有任务/阶段 `isEditable` 为 true

#### 5.2 修改项目列表接口
**文件**：`module_task/configuration/service/task_service.py` - `get_project_summary_list_services`

**修改内容**：
- 确保 `tasksGenerated` 字段正确计算（查询 `todo_task` 表）

---

### 阶段6：添加任务删除限制

#### 6.1 添加删除限制检查
**文件**：`module_task/configuration/service/persistence/task_persistence.py` - `_process_tasks`

**修改内容**：
- 在软删除任务前，检查任务是否已生成
- 如果已生成，不允许删除，抛出异常
- 如果未生成，允许删除（软删除，enable='0'）

#### 6.2 添加阶段删除限制检查
**文件**：`module_task/configuration/service/persistence/task_persistence.py` - `_process_stages`

**修改内容**：
- 在软删除阶段前，检查阶段是否已生成
- 如果已生成，不允许删除，抛出异常
- 如果未生成，允许删除（软删除，enable='0'）

---

## 三、关键实现细节

### 3.1 任务生成条件检查

```python
async def check_task_generation_condition(db, task_id):
    """
    检查任务是否满足生成条件
    """
    # 1. 从 proj_task 表获取任务配置
    proj_task = await get_proj_task(db, task_id)
    if not proj_task:
        return False
    
    # 2. 获取前置任务列表
    predecessor_tasks = parse_json(proj_task.predecessor_tasks)
    
    # 3. 如果前置任务为空，满足生成条件
    if not predecessor_tasks:
        return True
    
    # 4. 检查所有前置任务是否都完成
    for pred_id in predecessor_tasks:
        todo_task = await get_todo_task_by_task_id(db, pred_id)
        if not todo_task or todo_task.task_status != 3:  # 3-完成
            return False
    
    return True
```

### 3.2 阶段生成条件检查

```python
async def check_stage_generation_condition(db, stage_id):
    """
    检查阶段是否满足生成条件
    """
    # 1. 从 proj_stage 表获取阶段配置
    proj_stage = await get_proj_stage(db, stage_id)
    if not proj_stage:
        return False
    
    # 2. 获取前置阶段列表
    predecessor_stages = parse_json(proj_stage.predecessor_stages)
    
    # 3. 如果前置阶段为空，满足生成条件
    if not predecessor_stages:
        return True
    
    # 4. 检查所有前置阶段是否都完成
    for pred_id in predecessor_stages:
        todo_stage = await get_todo_stage_by_stage_id(db, pred_id)
        if not todo_stage or todo_stage.stage_status != 2:  # 2-已完成
            return False
    
    return True
```

### 3.3 编辑限制检查

```python
async def check_edit_permission(db, task_id, is_generated):
    """
    检查任务编辑权限
    """
    if not is_generated:
        # 未生成的任务，可以编辑所有字段
        return True, []
    
    # 已生成的任务，只允许编辑后置关系
    # 需要在保存时检查具体修改的字段
    return False, ['predecessor_tasks']  # 不允许修改的字段列表
```

---

## 四、测试要点

### 4.1 任务生成测试
1. 第一次生成任务：只生成第一层任务
2. 任务完成后：检查后置任务是否生成
3. 保存更新后：检查新增/编辑的任务是否生成

### 4.2 任务编辑测试
1. 未生成任务：可以编辑所有字段
2. 已生成任务：只允许编辑后置关系
3. 已生成任务：不允许删除

### 4.3 前后置关系查询测试
1. 已生成任务：从 todo_task 表查询
2. 未生成任务：从 proj_task 表查询
3. 合并结果：返回完整的前后置任务关系

---

## 五、注意事项

1. **数据一致性**：确保 proj_task 和 todo_task 表的数据一致性
2. **性能优化**：批量查询，避免 N+1 查询问题
3. **错误处理**：添加详细的日志和错误处理
4. **事务管理**：确保所有操作在事务中执行

---

## 六、实施顺序

1. **阶段1**：基础逻辑和工具方法（is_editable、生成检查、统一生成方法）
2. **阶段2**：修改任务生成逻辑（第一次生成、动态生成）
3. **阶段3**：添加任务编辑限制检查
4. **阶段4**：修改前后置任务关系查询
5. **阶段5**：添加 is_editable 字段到接口
6. **阶段6**：添加任务删除限制

每个阶段完成后，进行测试，确保功能正常。
