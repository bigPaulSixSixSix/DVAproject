# 数据库表清理策略

## 一、表分类

### 1. 配置表（应保留）
这些表存储任务配置数据，是用户配置的基础数据，不应清理：

- **`proj_task`** - 项目任务表（任务配置）
- **`proj_stage`** - 项目阶段表（阶段配置）

### 2. 执行和审批表（应清空）
这些表存储任务生成后的执行数据和审批流程数据，应该清空以便重新测试：

#### 任务执行相关表
- **`todo_task`** - 任务执行表（从 proj_task 生成的任务执行记录）
- **`todo_stage`** - 阶段执行表（从 proj_stage 生成的阶段执行记录）
- **`todo_task_apply`** - 任务申请详情表（任务提交时的申请详情）

#### 审批流程相关表
- **`apply_primary`** - 申请单主表（审批流程的主表）
- **`apply_rules`** - 审批规则表（审批流程的规则配置）
- **`apply_log`** - 审批日志表（审批流程的日志记录）

## 二、清理SQL脚本

```sql
-- ============================================
-- 清理任务执行和审批相关表（测试准备）
-- ============================================

-- 1. 清理任务执行相关表
TRUNCATE TABLE todo_task;
TRUNCATE TABLE todo_stage;
TRUNCATE TABLE todo_task_apply;

-- 2. 清理审批流程相关表
TRUNCATE TABLE apply_log;
TRUNCATE TABLE apply_rules;
TRUNCATE TABLE apply_primary;

-- 注意：
-- 1. proj_task 和 proj_stage 表不清理（保留配置数据）
-- 2. 使用 TRUNCATE 而不是 DELETE，因为 TRUNCATE 更快且会重置自增ID
-- 3. 清理顺序：先清理依赖表（apply_log, apply_rules），再清理主表（apply_primary）
--    先清理 todo_task_apply，再清理 todo_task 和 todo_stage
```

## 三、表关系说明

### 数据流向
```
proj_task/proj_stage (配置表)
    ↓ 生成
todo_task/todo_stage (执行表)
    ↓ 提交
todo_task_apply (申请详情表)
    ↓ 创建审批流程
apply_primary (申请单主表)
    ↓ 关联
apply_rules (审批规则表)
    ↓ 记录审批
apply_log (审批日志表)
```

### 外键关系
- `todo_task_apply.apply_id` → `apply_primary.apply_id`
- `todo_task_apply.task_id` → `todo_task.id`
- `apply_rules.apply_id` → `apply_primary.apply_id`
- `apply_log.apply_id` → `apply_primary.apply_id`

## 四、清理顺序建议

由于存在外键关系，建议按以下顺序清理：

1. **第一步：清理审批日志和规则**（依赖表）
   ```sql
   TRUNCATE TABLE apply_log;
   TRUNCATE TABLE apply_rules;
   ```

2. **第二步：清理申请单主表**
   ```sql
   TRUNCATE TABLE apply_primary;
   ```

3. **第三步：清理任务申请详情表**
   ```sql
   TRUNCATE TABLE todo_task_apply;
   ```

4. **第四步：清理任务执行表**
   ```sql
   TRUNCATE TABLE todo_task;
   TRUNCATE TABLE todo_stage;
   ```

## 五、注意事项

1. **配置表保留**：`proj_task` 和 `proj_stage` 表必须保留，因为它们是任务配置的基础数据
2. **外键约束**：如果数据库有外键约束，可能需要先禁用外键检查，清理后再启用
3. **自增ID重置**：使用 `TRUNCATE` 会自动重置自增ID，使用 `DELETE` 不会重置
4. **事务安全**：建议在事务中执行清理操作，以便出错时回滚

## 六、完整的清理脚本（考虑外键）

```sql
-- ============================================
-- 清理任务执行和审批相关表（测试准备）
-- 考虑外键约束的完整脚本
-- ============================================

-- 禁用外键检查（MySQL）
SET FOREIGN_KEY_CHECKS = 0;

-- 清理审批日志和规则（依赖表）
TRUNCATE TABLE apply_log;
TRUNCATE TABLE apply_rules;

-- 清理申请单主表
TRUNCATE TABLE apply_primary;

-- 清理任务申请详情表
TRUNCATE TABLE todo_task_apply;

-- 清理任务执行表
TRUNCATE TABLE todo_task;
TRUNCATE TABLE todo_stage;

-- 启用外键检查
SET FOREIGN_KEY_CHECKS = 1;

-- 注意：proj_task 和 proj_stage 表不清理（保留配置数据）
```

## 七、验证清理结果

清理后可以执行以下查询验证：

```sql
-- 验证配置表数据（应该有数据）
SELECT COUNT(*) FROM proj_task;
SELECT COUNT(*) FROM proj_stage;

-- 验证执行表数据（应该为0）
SELECT COUNT(*) FROM todo_task;
SELECT COUNT(*) FROM todo_stage;
SELECT COUNT(*) FROM todo_task_apply;

-- 验证审批表数据（应该为0）
SELECT COUNT(*) FROM apply_primary;
SELECT COUNT(*) FROM apply_rules;
SELECT COUNT(*) FROM apply_log;
```
