# 任务编辑和渐进式生成功能 - 前端更新文档

## 📋 文档说明

本文档描述了任务编辑和渐进式生成功能的后端实现变更，以及前端需要对应的修改内容。请前端开发人员根据本文档完成相应的UI/UX调整和功能实现。

**版本**: v1.0  
**更新日期**: 2026-01-05  
**适用范围**: 任务配置、任务执行、我的任务、历史任务等模块

---

## 一、功能概述

### 1.1 核心功能

本次更新包含两大核心功能：

1. **任务编辑功能**
   - 允许编辑未生成的任务/阶段（完全可编辑）
   - 已生成的任务/阶段只允许编辑后置关系
   - 已生成的任务/阶段不允许删除

2. **渐进式任务生成**
   - 第一次生成任务时，只生成第一层任务/阶段（没有前置任务/阶段的任务）
   - 后续任务/阶段在前置任务/阶段完成后自动生成
   - 保存配置后，自动检查并生成满足条件的新任务/阶段

### 1.2 核心原则

- **只允许编辑未生成的任务/阶段**：判断标准是任务/阶段是否已在 `todo_task`/`todo_stage` 表中存在
- **不存在跨阶段任务关联**：任务的前置任务必须在同一个阶段内
- **动态计算 `isEditable`**：该字段由后端动态计算，不存储在数据库中

---

## 二、API接口变更

### 2.1 获取任务配置接口

**接口路径**: `GET /task/config/{project_id}`  
**接口名称**: `get_task_config_by_project_id`

#### 变更内容

1. **新增字段**: `tasksGenerated`（项目级别）
   - **类型**: `boolean`
   - **说明**: 标识该项目是否已生成任务
   - **位置**: 返回数据的根级别
   - **用途**: 前端用于区分"保存任务"和"保存并更新任务生成"两种操作模式

2. **新增字段**: `isEditable`（任务和阶段级别）
   - **类型**: `boolean`
   - **说明**: 标识任务/阶段是否可编辑
   - **位置**: 每个 `stage` 和 `task` 对象中
   - **计算规则**:
     - 如果项目未生成任务（`tasksGenerated = false`），所有任务/阶段 `isEditable = true`
     - 如果项目已生成任务（`tasksGenerated = true`），动态计算：
       - 任务在 `todo_task` 表中存在 → `isEditable = false`
       - 任务不在 `todo_task` 表中 → `isEditable = true`
       - 阶段在 `todo_stage` 表中存在 → `isEditable = false`
       - 阶段不在 `todo_stage` 表中 → `isEditable = true`

#### 返回数据结构示例

```json
{
  "project_id": 1,
  "tasksGenerated": true,
  "stages": [
    {
      "id": 1,
      "name": "阶段1",
      "start_time": "2026-01-01",
      "end_time": "2026-01-10",
      "predecessor_stages": [],
      "successor_stages": [2],
      "isEditable": false,  // 新增字段
      "position": {...}
    }
  ],
  "tasks": [
    {
      "id": 101,
      "name": "任务1",
      "description": "任务描述",
      "start_time": "2026-01-01",
      "end_time": "2026-01-05",
      "job_number": "E001",
      "stage_id": 1,
      "predecessor_tasks": [],
      "successor_tasks": [102],
      "isEditable": false,  // 新增字段
      "approval_type": "specified",
      "approval_nodes": [1, 2],
      "position": {...}
    },
    {
      "id": 102,
      "name": "任务2",
      "description": "任务描述",
      "start_time": "2026-01-06",
      "end_time": "2026-01-10",
      "job_number": "E002",
      "stage_id": 1,
      "predecessor_tasks": [101],
      "successor_tasks": [],
      "isEditable": true,  // 新增字段：未生成，可编辑
      "approval_type": "specified",
      "approval_nodes": [1, 2],
      "position": {...}
    }
  ]
}
```

### 2.2 获取项目列表接口

**接口路径**: `GET /task/project/summary`  
**接口名称**: `get_project_summary_list`

#### 变更内容

- **字段**: `tasksGenerated`（已存在，但计算逻辑已更新）
  - **类型**: `boolean`
  - **说明**: 动态计算，查询 `todo_task` 表判断项目是否已生成任务
  - **位置**: 每个项目对象中

#### 返回数据结构示例

```json
{
  "total": 10,
  "rows": [
    {
      "project_id": 1,
      "project_name": "项目1",
      "stage_count": 3,
      "task_count": 15,
      "tasks_generated": true,  // 已生成任务
      "create_time": "2026-01-01 10:00:00",
      "update_time": "2026-01-05 15:30:00",
      ...
    }
  ]
}
```

### 2.3 任务详情接口（前后置任务关系）

**接口路径**: `GET /todo/task/detail/{task_id}`  
**接口名称**: `get_task_detail`

#### 变更内容

**前后置任务查询逻辑变更**：

1. **查询范围扩展**：
   - 之前：只查询 `todo_task` 表（已生成的任务）
   - 现在：同时查询 `todo_task` 和 `proj_task` 表

2. **未生成任务的字段处理**：
   - 如果任务只在 `proj_task` 表中（未生成），返回以下字段：
     - `taskStatus`: `-1`（未生成）
     - `taskStatusName`: `"未生成"`
     - 其他执行相关字段（如 `actualStartTime`, `actualCompleteTime` 等）为 `null`

3. **字段一致性**：
   - 保持接口字段结构一致，方便前端统一处理
   - 已生成任务和未生成任务使用相同的字段结构

#### 返回数据结构示例

```json
{
  "taskId": 101,
  "taskName": "任务1",
  "taskStatus": 1,
  "taskStatusName": "进行中",
  "predecessorTasks": [
    {
      "taskId": 100,
      "taskName": "前置任务",
      "taskStatus": 3,
      "taskStatusName": "完成",
      "actualStartTime": "2026-01-01 09:00:00",
      "actualCompleteTime": "2026-01-05 18:00:00",
      ...
    }
  ],
  "successorTasks": [
    {
      "taskId": 102,
      "taskName": "后置任务（未生成）",
      "taskStatus": -1,  // 未生成
      "taskStatusName": "未生成",
      "actualStartTime": null,  // 未生成任务，执行相关字段为null
      "actualCompleteTime": null,
      ...
    }
  ],
  ...
}
```

### 2.4 保存任务配置接口

**接口路径**: `POST /task/save`  
**接口名称**: `save_task_config`

#### 变更内容

1. **保存逻辑变更**：
   - 对于已生成任务的项目，保存后会自动检查并生成满足条件的新任务/阶段
   - 生成条件：
     - 没有前置任务/阶段，或
     - 所有前置任务/阶段都已完成

2. **编辑限制检查**：
   - 后端会检查是否尝试编辑不允许编辑的任务/阶段
   - 如果违反规则，会返回错误信息

#### 错误响应示例

```json
{
  "code": 500,
  "msg": "不允许编辑已生成的任务基本信息",
  "data": null
}
```

---

## 三、前端UI/UX变更

### 3.1 任务配置页面

#### 3.1.1 项目级别操作

**根据 `tasksGenerated` 字段显示不同的操作按钮**：

- **未生成任务的项目** (`tasksGenerated = false`):
  - 显示按钮：**"保存任务"**
  - 说明：所有任务/阶段都可以自由编辑

- **已生成任务的项目** (`tasksGenerated = true`):
  - 显示按钮：**"保存并更新任务生成"**
  - 说明：保存后会检查并生成满足条件的新任务/阶段
  - 提示信息：可以显示提示"保存后，系统将自动检查并生成满足条件的新任务"

#### 3.1.2 任务/阶段的可编辑性显示

**根据 `isEditable` 字段控制UI显示和操作**：

1. **不可编辑的任务/阶段** (`isEditable = false`):
   - **视觉样式**：
     - 使用灰色样式（禁用状态）
     - 可以添加图标或标签标识"已生成"
   - **禁止的操作**：
     - ❌ 不允许编辑基本信息（名称、描述、时间、负责人、审批节点等）
     - ❌ 不允许编辑前置关系（左侧连接线、前置任务/阶段选择）
     - ❌ 不允许删除
   - **允许的操作**：
     - ✅ 可以编辑后置关系（右侧连接线、后置任务/阶段选择）
     - ✅ 可以向已生成的阶段中添加新任务（但新任务需要遵循编辑限制）

2. **可编辑的任务/阶段** (`isEditable = true`):
   - **视觉样式**：
     - 正常样式显示
   - **允许的操作**：
     - ✅ 可以编辑所有信息（名称、描述、时间、负责人、审批节点等）
     - ✅ 可以编辑前后置关系
     - ✅ 可以删除（软删除）

#### 3.1.3 前后置关系编辑限制

**前置关系（左侧连接线）**：
- 如果任务/阶段 `isEditable = false`：
  - 禁止编辑/删除该任务/阶段的前置关系
  - 禁止将该任务/阶段设置为其他任务/阶段的前置

**后置关系（右侧连接线）**：
- 如果任务/阶段 `isEditable = false`：
  - 允许编辑/删除该任务/阶段的后置关系
  - 但只能添加/删除 `isEditable = true` 的任务/阶段作为后置
  - 禁止添加 `isEditable = false` 的任务/阶段作为后置

**具体规则示例**：
- ✅ 已生成任务A → 未生成任务B：可以设置关系
- ✅ 已生成任务A → 未生成任务B：可以删除关系
- ❌ 已生成任务A → 已生成任务B：不可以设置新关系
- ❌ 已生成任务A → 已生成任务B：不可以删除已存在的关系

#### 3.1.4 向已生成阶段添加新任务

**允许操作，但需要遵循限制**：
- ✅ 可以向 `isEditable = false` 的阶段中添加新任务
- ⚠️ 新添加的任务：
  - 不能将任何 `isEditable = false` 的任务设置为前置
  - 不能将任何 `isEditable = false` 的任务设置为后置
  - 可以正常编辑其他信息

### 3.2 我的任务/历史任务页面

#### 3.2.1 前后置任务关系显示

**处理未生成任务的显示**：

1. **任务状态显示**：
   - 如果 `taskStatus = -1` 且 `taskStatusName = "未生成"`：
     - 显示特殊标识（如标签、图标）
     - 使用不同的样式（如灰色、虚线边框）
     - 显示提示信息："该任务尚未生成"

2. **字段处理**：
   - 对于未生成的任务，执行相关字段（如实际开始时间、实际完成时间）为 `null`
   - 前端需要处理 `null` 值，显示为 "-" 或空

3. **交互限制**：
   - 未生成的任务可能无法点击查看详情（根据业务需求）
   - 或者可以点击，但详情页面显示"任务未生成"的提示

#### 3.2.2 任务列表显示

**建议的显示方式**：

```javascript
// 伪代码示例
function renderTaskStatus(task) {
  if (task.taskStatus === -1) {
    return {
      text: '未生成',
      type: 'info',  // 信息类型标签
      icon: 'clock',  // 时钟图标
      style: { color: '#909399', borderStyle: 'dashed' }  // 灰色虚线
    }
  }
  // 其他状态的处理...
}
```

---

## 四、业务逻辑说明

### 4.1 任务生成时机

1. **第一次生成任务**：
   - 用户点击"生成任务"按钮
   - 只生成第一层任务/阶段（没有前置任务/阶段的任务）

2. **动态生成任务**：
   - 任务完成后，自动检查并生成后置任务
   - 阶段完成后，自动检查并生成后置阶段
   - 阶段生成后，自动生成阶段内的头任务（没有前置任务的任务）

3. **保存后生成**：
   - 保存任务配置后，自动检查并生成满足条件的新任务/阶段
   - 生成条件：没有前置任务/阶段，或所有前置任务/阶段都已完成

### 4.2 编辑限制规则

#### 4.2.1 已生成任务/阶段的编辑限制

**基本信息**：
- ❌ 不允许修改：名称、描述、时间、负责人、审批节点等

**前置关系**：
- ❌ 不允许修改：`predecessor_tasks`、`predecessor_stages`

**后置关系**：
- ✅ 允许修改：`successor_tasks`、`successor_stages`
- ⚠️ 限制：只能添加/删除未生成的任务/阶段

**删除**：
- ❌ 不允许删除

#### 4.2.2 未生成任务/阶段的编辑权限

- ✅ 可以编辑所有信息
- ✅ 可以编辑前后置关系
- ✅ 可以删除

### 4.3 前后置任务关系查询

**查询逻辑**：
1. 先从 `todo_task` 表查询（已生成的任务）
2. 如果查询不到，从 `proj_task` 表查询（未生成的任务）
3. 合并结果，返回完整的前后置任务关系

**前端处理**：
- 需要同时处理已生成和未生成的任务
- 未生成任务的状态为 `-1`，其他执行相关字段为 `null`

---

## 五、前端实现建议

### 5.1 数据结构处理

```typescript
// TypeScript 类型定义示例
interface Task {
  id: number;
  name: string;
  description?: string;
  start_time?: string;
  end_time?: string;
  job_number?: string;
  stage_id?: number;
  predecessor_tasks: number[];
  successor_tasks: number[];
  isEditable: boolean;  // 新增字段
  approval_type?: string;
  approval_nodes: number[];
  position?: TaskPosition;
}

interface Stage {
  id: number;
  name: string;
  start_time?: string;
  end_time?: string;
  predecessor_stages: number[];
  successor_stages: number[];
  isEditable: boolean;  // 新增字段
  position?: StagePosition;
}

interface TaskConfigResponse {
  project_id: number;
  tasksGenerated: boolean;  // 新增字段
  stages: Stage[];
  tasks: Task[];
}
```

### 5.2 UI组件建议

#### 5.2.1 任务/阶段卡片组件

```vue
<template>
  <div 
    :class="[
      'task-card',
      { 'task-card--disabled': !task.isEditable }
    ]"
  >
    <!-- 已生成标识 -->
    <el-tag v-if="!task.isEditable" type="info" size="small">
      已生成
    </el-tag>
    
    <!-- 任务内容 -->
    <div class="task-content">
      <!-- 基本信息：根据 isEditable 控制是否可编辑 -->
      <el-input 
        v-if="task.isEditable"
        v-model="task.name"
        placeholder="任务名称"
      />
      <span v-else class="task-name--readonly">{{ task.name }}</span>
      
      <!-- 其他字段... -->
    </div>
    
    <!-- 操作按钮 -->
    <div class="task-actions">
      <el-button 
        v-if="task.isEditable"
        type="danger" 
        size="small"
        @click="handleDelete"
      >
        删除
      </el-button>
    </div>
  </div>
</template>

<style scoped>
.task-card--disabled {
  opacity: 0.6;
  background-color: #f5f7fa;
  border-color: #e4e7ed;
  cursor: not-allowed;
}
</style>
```

#### 5.2.2 连接线组件

```vue
<template>
  <div class="connection-line">
    <!-- 前置连接线 -->
    <div 
      v-if="task.predecessor_tasks.length > 0"
      :class="[
        'predecessor-line',
        { 'predecessor-line--disabled': !task.isEditable }
      ]"
    >
      <!-- 连接线内容 -->
      <!-- 如果不可编辑，禁用交互 -->
    </div>
    
    <!-- 后置连接线 -->
    <div 
      v-if="task.successor_tasks.length > 0"
      class="successor-line"
      :class="{ 'successor-line--limited': !task.isEditable }"
    >
      <!-- 连接线内容 -->
      <!-- 如果不可编辑，限制只能添加未生成的任务 -->
    </div>
  </div>
</template>
```

### 5.3 保存按钮逻辑

```vue
<template>
  <div class="save-actions">
    <el-button 
      v-if="!tasksGenerated"
      type="primary"
      @click="handleSave"
    >
      保存任务
    </el-button>
    
    <el-button 
      v-else
      type="primary"
      @click="handleSaveAndGenerate"
    >
      保存并更新任务生成
    </el-button>
    
    <el-tooltip 
      v-if="tasksGenerated"
      content="保存后，系统将自动检查并生成满足条件的新任务"
      placement="top"
    >
      <el-icon class="info-icon">
        <QuestionFilled />
      </el-icon>
    </el-tooltip>
  </div>
</template>
```

### 5.4 前后置任务关系显示

```vue
<template>
  <div class="task-relations">
    <!-- 前置任务 -->
    <div class="predecessor-tasks">
      <h4>前置任务</h4>
      <div 
        v-for="predTask in predecessorTasks" 
        :key="predTask.taskId"
        :class="[
          'task-item',
          { 'task-item--ungenerated': predTask.taskStatus === -1 }
        ]"
      >
        <el-tag 
          v-if="predTask.taskStatus === -1"
          type="info"
          size="small"
        >
          未生成
        </el-tag>
        <span>{{ predTask.taskName }}</span>
        <span v-if="predTask.taskStatus !== -1" class="task-status">
          {{ predTask.taskStatusName }}
        </span>
      </div>
    </div>
    
    <!-- 后置任务 -->
    <div class="successor-tasks">
      <h4>后置任务</h4>
      <!-- 类似处理... -->
    </div>
  </div>
</template>

<style scoped>
.task-item--ungenerated {
  opacity: 0.6;
  border-style: dashed;
}
</style>
```

---

## 六、测试要点

### 6.1 功能测试

1. **任务编辑测试**：
   - [ ] 未生成任务的项目：所有任务/阶段都可以编辑
   - [ ] 已生成任务的项目：已生成任务/阶段显示为灰色，不可编辑基本信息
   - [ ] 已生成任务/阶段：可以编辑后置关系
   - [ ] 已生成任务/阶段：不可以删除
   - [ ] 已生成阶段：可以添加新任务

2. **任务生成测试**：
   - [ ] 第一次生成任务：只生成第一层任务/阶段
   - [ ] 任务完成后：后置任务自动生成
   - [ ] 保存配置后：满足条件的新任务自动生成

3. **前后置关系测试**：
   - [ ] 已生成任务的前置关系：不可编辑
   - [ ] 已生成任务的后置关系：可以编辑，但只能添加未生成任务
   - [ ] 未生成任务的显示：状态为"未生成"，其他字段为null

### 6.2 UI测试

1. **视觉样式**：
   - [ ] 不可编辑任务/阶段：灰色样式显示
   - [ ] 未生成任务：特殊标识（标签、图标）
   - [ ] 保存按钮：根据 `tasksGenerated` 显示不同文本

2. **交互测试**：
   - [ ] 不可编辑任务/阶段：基本信息输入框禁用
   - [ ] 不可编辑任务/阶段：删除按钮隐藏或禁用
   - [ ] 前置关系编辑：不可编辑任务的前置关系不可编辑
   - [ ] 后置关系编辑：不可编辑任务的后置关系可以编辑，但有限制

### 6.3 边界情况测试

1. **数据为空**：
   - [ ] `isEditable` 字段缺失时的处理
   - [ ] `tasksGenerated` 字段缺失时的处理

2. **状态异常**：
   - [ ] 未生成任务的状态显示（`taskStatus = -1`）
   - [ ] null 值的处理（执行相关字段）

---

## 七、注意事项

### 7.1 兼容性

- 确保向后兼容：如果后端返回的数据中没有 `isEditable` 或 `tasksGenerated` 字段，前端应该有默认处理
- 建议：`isEditable` 默认值为 `true`，`tasksGenerated` 默认值为 `false`

### 7.2 性能优化

- `isEditable` 字段是动态计算的，前端不需要缓存
- 每次获取任务配置时，都会返回最新的 `isEditable` 值

### 7.3 错误处理

- 如果后端返回编辑限制错误，前端应该显示友好的错误提示
- 建议：在保存前进行前端校验，减少不必要的请求

### 7.4 用户体验

- 对于不可编辑的任务/阶段，应该提供明确的视觉反馈
- 对于未生成的任务，应该提供清晰的说明信息
- 保存按钮的文本应该清晰表达操作的含义

---

## 八、API接口清单

### 8.1 已变更的接口

| 接口路径 | 方法 | 变更内容 |
|---------|------|---------|
| `/task/config/{project_id}` | GET | 新增 `tasksGenerated`、`isEditable` 字段 |
| `/task/project/summary` | GET | `tasksGenerated` 计算逻辑更新 |
| `/todo/task/detail/{task_id}` | GET | 前后置任务查询逻辑变更，支持未生成任务 |
| `/task/save` | POST | 保存后自动生成满足条件的新任务 |

### 8.2 接口文档

详细的接口文档请参考后端API文档，或联系后端开发人员获取最新的接口规范。

---

## 九、联系与支持

如有疑问或需要技术支持，请联系：

- **后端开发负责人**: [待填写]
- **前端开发负责人**: [待填写]
- **项目负责人**: [待填写]

---

## 十、更新日志

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-01-05 | 初始版本，完整的功能更新文档 | [待填写] |

---

**文档结束**
